name: Sync assets (screenshots) from manifest

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-assets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Download assets from manifest
        shell: bash
        run: |
          set -euo pipefail

          MANIFEST="tools/assets_manifest.json"
          if [ ! -f "$MANIFEST" ]; then
            echo "Manifest not found: $MANIFEST"
            exit 1
          fi

          # Iterate keys (ficha codes)
          for code in $(jq -r 'keys[]' "$MANIFEST"); do
            count=$(jq -r --arg code "$code" '.[$code] | length' "$MANIFEST")
            if [ "$count" -gt 2 ]; then
              echo "ERROR: $code has $count assets (max 2)."
              exit 1
            fi

            for i in $(seq 0 $((count-1))); do
              url=$(jq -r --arg code "$code" --argjson i "$i" '.[$code][$i].url' "$MANIFEST")
              dest=$(jq -r --arg code "$code" --argjson i "$i" '.[$code][$i].dest' "$MANIFEST")

              if [ -z "$url" ] || [ -z "$dest" ] || [ "$url" = "null" ] || [ "$dest" = "null" ]; then
                echo "ERROR: invalid entry for $code[$i]"
                exit 1
              fi

              mkdir -p "$(dirname "$dest")"
              echo "Downloading $url -> $dest"
              curl -L --fail --retry 3 --retry-delay 2 "$url" -o "$dest"
            done
          done

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain | grep -q .; then
            git config user.name "puyu-bot"
            git config user.email "bot@puyu.pe"
            git add docs/assets/img tools/assets_manifest.json
            git commit -m "chore(assets): sync screenshots from manifest"
            git push
          else
            echo "No changes to commit."
          fi
